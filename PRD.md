# FIRE 提領與所需資產試算 web app（含稅負與費用）

## 一句話目標

讓使用者輸入提領、報酬、通膨、稅負與費用條件後，立即得到所需起始資產與年度現金流的稅後視圖

## 新增背景
- 實務規劃多半為「稅後可支配金額」目標
- 稅負與費用會大幅影響可持續提領率與所需資產
- 需支援不同帳戶型態與不同課稅方式的快速估算

## 產品目標補強
- 支援三種帳戶型態：一般應稅、延稅、免稅
- 同時支援稅前提領目標與稅後到手目標兩種模式
- 年度表清楚列示：費用、稅金、稅後提領、期末資產

## 範圍與非目標更新

### MVP+ 範圍（v1.2）
**新增輸入**
- 帳戶型態：一般應稅 / 延稅 / 免稅
- 年度總費用率 f%（含基金費用、顧問費用等，預設 0.25）
- 報酬結構拆分：股息利息殖利率 y% 與價格成長 a%（r = y + a）
- 一般應稅帳戶的股息利息稅率 τ_div%
- 一般應稅帳戶的資本利得稅率 τ_cg%（僅在賣出實現時課）
- 延稅帳戶的提領稅率 τ_withdraw%
- 目標金額模式：到手淨額 or 稅前提領

**新增輸出**
- 稅後淨提領與為達到該淨額所需的稅前提領
- 年度費用金額與年度稅額
- 三種帳戶型態下的所需起始資產對照
- 年度表列欄位新增：費用、已實現資本利得、股息稅、資本利得稅、提領稅、稅後提領

### 非目標（保留至後續版本）
- 分國家稅制細節與級距
- 交易時點最佳化與損益相抵
- 扣除額與可抵稅費用的精算

## 使用者與情境補充
- 台灣或全球投資者，希望估算稅後可支配現金流
- 顧問與客戶對話時比較不同帳戶型態的影響

## 輸入

### 必填
- 第一年度目標提領 W1（可選為稅前或稅後）
- 通膨 g%
- 總報酬拆分：股息利息 y%，價格成長 a%，要求 y + a = r
- 年期 n
- 提領時點 timing ∈ {期末 end, 期初 begin}

### 稅與費用
- 總費用率 f%（對資產年收，預設 0.25）
- 帳戶型態
  - 一般應稅 taxable：τ_div%，τ_cg%
  - 延稅 tax deferred：τ_withdraw%
  - 免稅 tax free：無稅參數
- 目標金額模式
  - 稅後到手 W1_net 或 稅前 W1_gross

## 計算邏輯與公式

### 共同步驟
- 若選「稅後到手」模式，先把第一年稅後目標換算成稅前提領
- 一般應稅與免稅帳戶：稅前提領 = 稅後到手（因無「提領稅」概念，稅發生在收益或賣出處）
- 延稅帳戶：W1_gross = W1_net ÷ (1 − τ_withdraw)
- 期末領與期初領的成長年金現值仍為基礎框架（見先前 PRD）
- 但「有效報酬率」需先扣除費用與稅負影響

### 帳戶型態與稅務模型

#### A 一般應稅 taxable（MVP+ 近似模型）
**年度現金流順序（年 y，期初資產 B_{y−1}，基礎成本 cost_{y−1}）**

1. **費用** fee_y = f × B_{y−1}
2. **股息利息** div_y = y × B_{y−1}，課稅 tax_div_y = τ_div × div_y
   - 可用於支出，若未用則淨額再投資並增加成本基礎
3. **價格成長** app_y = a × B_{y−1}（不即時課稅）
4. **稅前提領需求 W_y**
   - 先用 div_y − tax_div_y 支付
   - 不足部分賣出資產 Sell_y
   - 假設平均成本法，未實現利得率 ug_ratio = max(B_{y−1} − cost_{y−1}, 0) ÷ B_{y−1}
   - 已實現資本利得 gain_y = Sell_y × ug_ratio
   - 資本利得稅 tax_cg_y = τ_cg × gain_y
   - 為達成 W_y，實際賣出需滿足 Sell_y − tax_cg_y = 資金缺口
5. **期末資產**
   - B_y = B_{y−1} + app_y + div_y − tax_div_y − fee_y − Sell_y
   - 成本基礎更新
   - cost_y = cost_{y−1} + 再投資股息淨額 − 成本被賣出部分
   - 成本被賣出部分 = Sell_y × (1 − ug_ratio)

**簡化有效報酬的心法（用於快速估算卡片數字）**
- 近似 r_eff ≈ a + y × (1 − τ_div) − f
- 但年度表與所需資產以完整步驟計算，確保稅額正確

#### B 延稅 tax deferred（如傳統退休帳戶）
- 年內不課投資稅，費用仍收
- 年度提領需課「提領稅」
- 若目標是稅後 W_y_net，則 W_y_gross = W_y_net ÷ (1 − τ_withdraw)
- 資產演進：期末資產 B_y = B_{y−1} × (1 + r − f) − W_y_gross

#### C 免稅 tax free（如 Roth 類型）
- 年內不課稅，也無提領稅，僅扣費用
- 期末資產 B_y = B_{y−1} × (1 + r − f) − W_y

**備註**
- r = a + y 為名目報酬
- 所有稅率以固定單一稅率近似，不做級距
- 期初與期末領兩種時點均適用上述流程

### 所需起始資產計算
**卡片快速答案**
- 先換算 W1_gross（如為稅後模式且為延稅帳戶）
- 估算有效報酬 r_eff（依帳戶型態）
- 以 r_eff 套用成長年金現值給出「初步所需資產」

**年度表精算**
- 以年度模擬逐年回推，調整初始資產使第 n 年結束時恰不為負（數值解，容許 ±1 元）
- 這筆即為精算所需起始資產，並用於畫面顯示

## 輸出

### 卡片
- 三種帳戶型態下的所需起始資產對照
- 第一年的稅前提領、稅後到手、年度費用與稅額估計
- 4% 法則對照（僅為參考）

### 年度表
- 年、期初資產、費用、股息、股息稅、價格成長、已實現利得、資本利得稅、提領稅、稅前提領、稅後到手、期末資產

## 驗證與錯誤處理
- 檢查 y + a = r，否則提示並阻止計算
- 稅率 0–60%，費用率 0–3%，超出範圍提示
- 當 ug_ratio 未定義時以 0 處理（全為成本，無利得）
- 數值解不收斂時提供建議：降低稅後目標或提高年期與報酬

## 成功指標
- 在相同 W1、r、g、n 下，一般應稅帳戶的所需資產 ≥ 免稅帳戶
- 開啟到首個含稅結果 ≤ 2 秒
- 年度稅額與費用加總一致性檢查通過（資產流量平衡）
- 頁面載入時間 < 3 秒（GitHub Pages）
- 支援所有現代瀏覽器（Chrome, Firefox, Safari, Edge）
- 離線功能正常運作

## 例題與驗收標準

### 測試組 A 延稅帳戶
**參數：** W1_net=1,500,000，τ_withdraw=20%，r=5%，f=0.25%，g=2%，n=30，期末領
**驗收：** 第一年稅前提領 W1_gross = 1,875,000
**精算所需資產應高於無稅版本約 5–8%（依 f 與稅率而定）**

### 測試組 B 一般應稅帳戶
**參數：** W1_gross=1,500,000，y=2%，a=3%，τ_div=28%，τ_cg=15%，f=0.25%，g=2%，n=30，期末領
**驗收：**
- 年度表第 1 年會先以稅後股息支付部分提領，剩餘缺口賣出資產並計算資本利得稅
- 三十年累積資本利得稅 > 0，費用逐年隨資產變動

## 使用體驗與介面更新
- 新增區塊 稅與費用
- 帳戶型態選擇器
- 對應稅率輸入欄位動態顯示
- 費用率 f%
- 提示文字說明模型假設與限制
- 目標金額模式切換
- 稅前或稅後，到手模式會自動換算所需稅前提領

## 非功能需求
- 純前端單頁應用，無後端依賴
- 所有計算於瀏覽器端進行
- 以平均成本法近似，不保存個別交易
- 支援離線使用（除初始載入外）
- 快速載入（< 2秒）
- 響應式設計，支援手機、平板、桌面

## 可存取性與在地化
- 保持繁中
- 稅率欄位加上說明工具提示，避免誤解

## 技術方案
**部署架構**
- 純前端單頁應用 (SPA)
- 部署於 GitHub Pages
- 無後端服務器，無資料庫
- 所有計算在瀏覽器端執行

**計算引擎新增兩層**
1. **快速估算層：** 以 r_eff 立即產出卡片答案
2. **逐年模擬層：** 含費用、股息稅、資本利得稅與成本基礎，並以數值法校正所需起始資產

**技術棧**
- **框架：** React 或 Vue.js
- **樣式：** Tailwind CSS
- **圖表：** Chart.js 或 D3.js
- **部署：** GitHub Pages
- **狀態管理：** 本地狀態，無需持久化

**主要資料結構**
- balance, cost_basis, unrealized_gain, realized_gain, taxes_div, taxes_cg, taxes_withdraw, fees

## 風險與假設
- 單一固定稅率近似，不含級距與扣除額
- 資本利得稅以平均成本法估算，與實際 FIFO/LIFO 可能不同
- 不處理海外預扣稅與外匯

## 路線圖建議
- **v1.3 高擬真稅制：** 級距與邊際稅率、免稅額、預扣稅
- **v1.4 情境比較與報表：** 三帳戶型態並排表格、CSV 匯出、圖表
- **v1.5 蒙地卡羅：** 報酬波動與破產機率

## 開發驗收清單
- y + a = r 驗證
- 三帳戶型態切換正確影響 UI 與結果
- 稅後模式在延稅帳戶能換算為稅前提領
- 年度表中的稅額與費用合計與資產變動一致
- 逐年模擬的精算所需資產與快速估算差距在 3% 以內（合理範圍提示）
- 手機介面可讀性與欄位分組清晰
- GitHub Pages 部署成功
- 離線功能測試通過
- 跨瀏覽器相容性驗證
- 響應式設計在不同螢幕尺寸正常顯示 