# FIRE 提領與所需資產試算 web app（含稅負與費用）

## 一句話目標

讓使用者輸入提領、報酬、通膨、稅負與費用條件後，立即得到所需起始資產與年度現金流的稅後視圖

## 新增背景
- 實務規劃多半為「稅後可支配金額」目標
- 稅負與費用會大幅影響可持續提領率與所需資產
- 需支援不同帳戶型態與不同課稅方式的快速估算

## 產品目標補強
- 支援三種帳戶型態：一般應稅、延稅、免稅
- 同時支援稅前提領目標與稅後到手目標兩種模式
- 年度表清楚列示：費用、稅金、稅後提領、期末資產

## 範圍與非目標更新

### MVP+ 範圍（v1.2）
**新增輸入**
- 帳戶型態：一般應稅 / 延稅 / 免稅
- 年度總費用率 f%（含基金費用、顧問費用等，預設 0.25）
- 報酬結構拆分：股息利息殖利率 y% 與價格成長 a%（r = y + a）
- 一般應稅帳戶的股息利息稅率 τ_div%
- 一般應稅帳戶的資本利得稅率 τ_cg%（僅在賣出實現時課）
- 延稅帳戶的提領稅率 τ_withdraw%
- 目標金額模式：到手淨額 or 稅前提領

**新增輸出**
- 稅後淨提領與為達到該淨額所需的稅前提領
- 年度費用金額與年度稅額
- 三種帳戶型態下的所需起始資產對照
- 年度表列欄位新增：費用、已實現資本利得、股息稅、資本利得稅、提領稅、稅後提領

### 非目標（保留至後續版本）
- 分國家稅制細節與級距
- 交易時點最佳化與損益相抵
- 扣除額與可抵稅費用的精算

## 使用者與情境補充
- 台灣或全球投資者，希望估算稅後可支配現金流
- 顧問與客戶對話時比較不同帳戶型態的影響

## 輸入

### 必填
- 第一年度目標提領 W1（可選為稅前或稅後）
- 通膨 g%
- 總報酬拆分：股息利息 y%，價格成長 a%，要求 y + a = r
- 年期 n
- 提領時點 timing ∈ {期末 end, 期初 begin}

### 稅與費用
- 總費用率 f%（對資產年收，預設 0.25）
- 帳戶型態
  - 一般應稅 taxable：τ_div%，τ_cg%
  - 延稅 tax deferred：τ_withdraw%
  - 免稅 tax free：無稅參數
- 目標金額模式
  - 稅後到手 W1_net 或 稅前 W1_gross

## 計算邏輯與公式

### 共同步驟
- 若選「稅後到手」模式，先把第一年稅後目標換算成稅前提領
- 一般應稅與免稅帳戶：稅前提領 = 稅後到手（因無「提領稅」概念，稅發生在收益或賣出處）
- 延稅帳戶：W1_gross = W1_net ÷ (1 − τ_withdraw)
- 期末領與期初領的成長年金現值仍為基礎框架（見先前 PRD）
- 但「有效報酬率」需先扣除費用與稅負影響

### 帳戶型態與稅務模型

#### A 一般應稅 taxable（MVP+ 近似模型）
**年度現金流順序（年 y，期初資產 B_{y−1}，基礎成本 cost_{y−1}）**

1. **費用** fee_y = f × B_{y−1}
2. **股息利息** div_y = y × B_{y−1}，課稅 tax_div_y = τ_div × div_y
   - 可用於支出，若未用則淨額再投資並增加成本基礎
3. **價格成長** app_y = a × B_{y−1}（不即時課稅）
4. **稅前提領需求 W_y**
   - 先用 div_y − tax_div_y 支付
   - 不足部分賣出資產 Sell_y
   - 假設平均成本法，未實現利得率 ug_ratio = max(B_{y−1} − cost_{y−1}, 0) ÷ B_{y−1}
   - 已實現資本利得 gain_y = Sell_y × ug_ratio
   - 資本利得稅 tax_cg_y = τ_cg × gain_y
   - 為達成 W_y，實際賣出需滿足 Sell_y − tax_cg_y = 資金缺口
5. **期末資產**
   - B_y = B_{y−1} + app_y + div_y − tax_div_y − fee_y − Sell_y
   - 成本基礎更新
   - cost_y = cost_{y−1} + 再投資股息淨額 − 成本被賣出部分
   - 成本被賣出部分 = Sell_y × (1 − ug_ratio)

**簡化有效報酬的心法（用於快速估算卡片數字）**
- 近似 r_eff ≈ a + y × (1 − τ_div) − f
- 但年度表與所需資產以完整步驟計算，確保稅額正確

#### B 延稅 tax deferred（如傳統退休帳戶）
- 年內不課投資稅，費用仍收
- 年度提領需課「提領稅」
- 若目標是稅後 W_y_net，則 W_y_gross = W_y_net ÷ (1 − τ_withdraw)
- 資產演進：期末資產 B_y = B_{y−1} × (1 + r − f) − W_y_gross

#### C 免稅 tax free（如 Roth 類型）
- 年內不課稅，也無提領稅，僅扣費用
- 期末資產 B_y = B_{y−1} × (1 + r − f) − W_y

**備註**
- r = a + y 為名目報酬
- 所有稅率以固定單一稅率近似，不做級距
- 期初與期末領兩種時點均適用上述流程

### 所需起始資產計算
**卡片快速答案**
- 先換算 W1_gross（如為稅後模式且為延稅帳戶）
- 估算有效報酬 r_eff（依帳戶型態）
- 以 r_eff 套用成長年金現值給出「初步所需資產」

**年度表精算**
- 以年度模擬逐年回推，調整初始資產使第 n 年結束時恰不為負（數值解，容許 ±1 元）
- 這筆即為精算所需起始資產，並用於畫面顯示

## 輸出

### 卡片
- 三種帳戶型態下的所需起始資產對照
- 第一年的稅前提領、稅後到手、年度費用與稅額估計
- 4% 法則對照（僅為參考）

### 年度表
- 年、期初資產、費用、股息、股息稅、價格成長、已實現利得、資本利得稅、提領稅、稅前提領、稅後到手、期末資產

## 驗證與錯誤處理
- 檢查 y + a = r，否則提示並阻止計算
- 稅率 0–60%，費用率 0–3%，超出範圍提示
- 當 ug_ratio 未定義時以 0 處理（全為成本，無利得）
- 數值解不收斂時提供建議：降低稅後目標或提高年期與報酬

## 成功指標
- 在相同 W1、r、g、n 下，一般應稅帳戶的所需資產 ≥ 免稅帳戶
- 開啟到首個含稅結果 ≤ 2 秒
- 年度稅額與費用加總一致性檢查通過（資產流量平衡）
- 頁面載入時間 < 3 秒（GitHub Pages）
- 支援所有現代瀏覽器（Chrome, Firefox, Safari, Edge）
- 離線功能正常運作

## 例題與驗收標準

### 測試組 A 延稅帳戶
**參數：** W1_net=1,500,000，τ_withdraw=20%，r=5%，f=0.25%，g=2%，n=30，期末領
**驗收：** 第一年稅前提領 W1_gross = 1,875,000
**精算所需資產應高於無稅版本約 5–8%（依 f 與稅率而定）**

### 測試組 B 一般應稅帳戶
**參數：** W1_gross=1,500,000，y=2%，a=3%，τ_div=28%，τ_cg=15%，f=0.25%，g=2%，n=30，期末領
**驗收：**
- 年度表第 1 年會先以稅後股息支付部分提領，剩餘缺口賣出資產並計算資本利得稅
- 三十年累積資本利得稅 > 0，費用逐年隨資產變動

## 使用體驗與介面更新
- 新增區塊 稅與費用
- 帳戶型態選擇器
- 對應稅率輸入欄位動態顯示
- 費用率 f%
- 提示文字說明模型假設與限制
- 目標金額模式切換
- 稅前或稅後，到手模式會自動換算所需稅前提領

## 非功能需求
- 純前端單頁應用，無後端依賴
- 所有計算於瀏覽器端進行
- 以平均成本法近似，不保存個別交易
- 支援離線使用（除初始載入外）
- 快速載入（< 2秒）
- 響應式設計，支援手機、平板、桌面

## 可存取性與在地化
- 保持繁中
- 稅率欄位加上說明工具提示，避免誤解

## 技術方案
**部署架構**
- 純前端單頁應用 (SPA)
- 部署於 GitHub Pages
- 無後端服務器，無資料庫
- 所有計算在瀏覽器端執行

**計算引擎新增兩層**
1. **快速估算層：** 以 r_eff 立即產出卡片答案
2. **逐年模擬層：** 含費用、股息稅、資本利得稅與成本基礎，並以數值法校正所需起始資產

**技術棧**
- **框架：** React 或 Vue.js
- **樣式：** Tailwind CSS
- **圖表：** Chart.js 或 D3.js
- **部署：** GitHub Pages
- **狀態管理：** 本地狀態，無需持久化

**主要資料結構**
- balance, cost_basis, unrealized_gain, realized_gain, taxes_div, taxes_cg, taxes_withdraw, fees

## 風險與假設
- 單一固定稅率近似，不含級距與扣除額
- 資本利得稅以平均成本法估算，與實際 FIFO/LIFO 可能不同
- 不處理海外預扣稅與外匯

## 路線圖建議
- **v1.3 高擬真稅制：** 級距與邊際稅率、免稅額、預扣稅
- **v1.4 情境比較與報表：** 三帳戶型態並排表格、CSV 匯出、圖表
- **v1.5 蒙地卡羅：** 報酬波動與破產機率

## 開發驗收清單
- y + a = r 驗證
- 三帳戶型態切換正確影響 UI 與結果
- 稅後模式在延稅帳戶能換算為稅前提領
- 年度表中的稅額與費用合計與資產變動一致
- 逐年模擬的精算所需資產與快速估算差距在 3% 以內（合理範圍提示）
- 手機介面可讀性與欄位分組清晰
- GitHub Pages 部署成功
- 離線功能測試通過
- 跨瀏覽器相容性驗證
- 響應式設計在不同螢幕尺寸正常顯示 

2.0
#zh-tw

綜合 PRD｜房產模組 + 蒙地卡羅破產熱圖

一句話目標

在同一頁面中，同時評估「房租＋房貸」現金流與「投資波動」對 FIRE 破產風險的影響，讓使用者 30 秒內找到安全提領率

⸻

背景
	•	固定報酬模型忽略序列風險，易低估破產機率
	•	多數台灣 FIRE 族持有房產，卻沒工具能把房貸、空置、房價波動一次算進來
	•	把兩者合併，可直接回答「買房收租＋投資」到底能降多少破產風險

⸻

產品目標
	1.	使用者輸入房產與金融參數後，1 秒內產生破產機率熱圖
	2.	手機也能即時互動，不超過 0.8 秒延遲
	3.	提供 無房產、含房產 兩種熱圖，一鍵對照

⸻

MVP 範圍

必要功能

類別	功能
房產現金流	租金、空置率、維護費、房貸本息、房價年增長與波動
蒙地卡羅引擎	股票、債券、房產三資產的常態分佈 + 相關係數；1 萬路徑
破產判定	任一年金融資產 + 房產淨值 < 0 視為破產
熱圖	X 軸提領率 2–6%，Y 軸股權 0–100%，格點顯示破產機率
互動控制	模擬年期 30 / 40 / 50 年、房產占比 0 / 20%、路徑數 1k / 5k / 10k

非目標 (MVP 不做)
	•	稅級距精算、浮動房貸利率、非常態分佈

⸻

使用者情境
	1.	FIRE 規劃中：輸入現有房貸與房租，看 4% 提領還安全嗎
	2.	顧問簡報：現場調參數讓客戶直觀看到破產熱區
	3.	部落客寫文：截圖熱圖，說明不同提領率風險

⸻

主要輸入參數

分類	參數	預設值	備註
房產	市價 P₀	15,000,000	TWD
	年租金 R₀	360,000	滿租
	空置率 v%	10	
	維護 m%	1.5	對市價
	房價期望 μ_p%	3	
	房價波動 σ_p%	6	
	房貸本金 M₀	10,000,000	
	房貸利率 i%	2	固定
	期數 N 月	240	
金融	股票 μ_s 7% σ_s 15%	債券 μ_b 3% σ_b 6%	
	相關 ρ_sb 0.25 ρ_sp 0.40 ρ_bp 0.10		
提領	第一年稅後金額或提領率	自動帶入	
模擬	年期 n	40	
	路徑數	10,000	可選


⸻

計算邏輯
	1.	相關隨機向量：Cholesky 產生 (Z_s, Z_b, Z_p)
	2.	年報酬
	•	股票 r_s = e^{μ_s-0.5σ_s^2+σ_s Z_s}-1
	•	債券同理，房產用 μ_p, σ_p
	3.	房產現金流
	•	租金淨額 = R₀(1+g)^{y-1}(1-v)(1-τ_r)
	•	維護費 = P_{y-1}·m
	•	房貸本息 = 固定支付
	•	年淨流 = 租金 − 維護 − 房貸
	•	房價 → 幾何布朗運動
	4.	破產判定
	•	期初金融資產 + 房產淨流 < 提領稅前需求 → 需賣投資
	•	資產餘額 < 0 即破產
	5.	熱圖
	•	11 × 9 格點，共 99 次批次運算
	•	破產率 = 破產路徑 / 路徑總數
	•	Canvas 畫像素，綠→紅

⸻

輸出

主畫面
	•	兩張熱圖並排：無房產 vs 含房產
	•	Hover 顯示：股權%, 提領%, 破產機率
	•	頂部摘要卡：當前參數下破產機率、平均終值、最差 5% 終值

進階 (折疊)
	•	柱狀圖：提領率臨界點 vs 年期
	•	信賴區間線：資產終值 10/50/90 百分位

⸻

UI / UX
	•	新增「風險熱圖」分頁
	•	左側摺疊參數，右側熱圖
	•	手機版：參數→熱圖→摘要卡直向瀑布流
	•	顏色盲友善：熱圖格內加百分比文字

⸻

非功能需求
	•	單檔 HTML + JS + Canvas
	•	Web Worker 處理運算，不阻塞 UI
	•	10k 路徑 × 99 格 ≤ 1.2 s（桌機）
	•	移動端自動降路徑數至 5k 以內

⸻

成功指標
	•	使用者首次開啟到熱圖 ≤ 3 s
	•	70% 使用者能在 1 分鐘內找到破產 ≤ 5% 方案
	•	計算結果與 Excel 對照誤差 ≤ 1 pp

⸻

例題驗收

案例	參數	預期
A	提領 4% 股 60 房 0	40 年破產≈6%
B	同 A 但房貸 2% 收租 360k	破產降至≈4%
C	σ_s ↑25% σ_p ↑12%	熱圖整體紅區顯著擴大


⸻

技術方案
	•	CoreEngine：TypedArray + Web Worker
	•	MCStorage：相同格點快取
	•	DrawHeatmap：Canvas putImageData，每格 20 × 20 px

⸻

風險與假設
	•	常態分佈未含極端肥尾
	•	地產現金流稅制簡化為固定稅率
	•	低階手機運算能力不足，需自動降格與降路徑


⸻

開發驗收清單
	•	房產開關影響熱圖結果
	•	99 格 10k 路徑 ≤ 1.2 s
	•	Hover 數值與格子顏色一致
	•	手機 5k 路徑 ≤ 1 s
	•	年度表資產流與蒙地卡羅破產判定一致


